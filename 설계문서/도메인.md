# 재고관리 시스템 도메인 설계

---

## 1. 도메인 개요

고성능 재고관리 시스템은 "동시성 제어 하에서도 재고의 정합성을 보장하는" 것을 핵심 목표로 한다. 이를 위해 도메인은 **상품(Product)**, **재고 상태(ProductStock)**, **재고 감소 이력(StockDecreaseLog)** 로 구성된다.

도메인은 다음 목표를 만족하도록 설계한다:

* DataSource MySQL
* 재고 감소는 여러 동시성 전략(Pessimistic / Optimistic / Distributed Lock)으로 수행 가능
* 모든 감소 요청은 반드시 결과 기록(Log)
* 재고는 증가/감소 모두 관리 가능

---

## 2. 도메인 모델 (Logical Model)

### 2.1 Products

**상품의 기본 정보**를 가지고 있는 엔티티.

| 필드          | 타입           | 설명      |
|-------------|--------------|---------|
| product_id  | BIGINT (PK)  | 상품 ID   |
| name        | varchar(100) | 상품명     |
| price       | int          | 가격      |
| description | TEXT         | 설명 (옵션) |
| created_at  | DATETIME     | 생성 일시   |
| updated_at  | DATETIME     | 수정 일시   |

**역할:**

* 시스템 내에서 판매되는 상품의 정적 정보
* 재고와 1:1 관계를 맺는다

---

### 2.2 ProductStock

**재고의 현재 상태**를 표현하는 핵심 엔티티.

| 필드         | 타입          | 설명                     |
|------------|-------------|------------------------|
| stock_id   | BIGINT (PK) | Stock ID         |
| product_id | BIGINT (FK) | Product ID             |
| stock      | INT         | 현재 재고량                 |
| version    | INT         | Optimistic Lock용 버전 필드 |
| updated_at | DATETIME    | 최종 수정 시각               |

**역할:**

* 재고 감소/증가는 반드시 이 엔티티를 기준으로 처리
* 낙관적 락은 `version` 필드를 사용
* 비관적 락은 이 레코드 자체에 DB Row Lock을 부여

---

### 2.3 StockDecreaseLog

재고 감소 요청의 **모든 결과를 기록하는 로그 엔티티**.

| 필드         | 타입          | 설명                               |
|------------|-------------|----------------------------------|
| log_id     | BIGINT (PK) | 로그 PK                            |
| product_id | BIGINT      | 상품 ID                            |
| stock_id   | BIGINT      | 재고 ID                            |
| quantity   | INT         | 요청한 수량                           |
| status     | varchar(10) | 성공 여부                            |
| strategy   | varchar(20) | PESSIMISTIC / OPTIMISTIC / REDIS |
| elapsed_ms | INT         | 처리 시간(ms)                        |
| error_msg  | TEXT        | 실패 사유                            |
| created_at | DATETIME    | 로그 생성 시각                         |

**역할:**

* 모든 요청의 결과를 추적
* 실험/성능 비교 리포트에 활용
* 정합성 검증 배치에서 사용

---

## 3. 관계 모델

### 관계 다이어그램 (텍스트 표현)

```
Product (1) ─── (1) ProductStock

Product (1) ─── (*) StockDecreaseLog

RequestHistory (*) ─── (1) Product (참조)
```

---

## 4. 동시성 전략이 영향을 미치는 도메인 포인트

### ✔ Pessimistic Lock → ProductStock

* 이 엔티티 자체가 DB Row-level Lock을 갖게 된다
* 서비스 레이어에서 SELECT FOR UPDATE 수행

### ✔ Optimistic Lock → ProductStock.version

* 재고 감소 시 `version` 비교 필요

### ✔ Redis Lock → ProductStock + Redis

* 락 자체는 Redis에서 관리
* 재고 감소는 ProductStock 업데이트로 종료

---

## 5. 도메인 규칙 (Domain Rules)

### DR-01. 재고는 절대 음수가 될 수 없다.

```
if (stock < quantity) → 실패
```

### DR-02. 모든 재고 감소는 StockDecreaseLog에 반드시 기록된다.

### DR-03. 재고 감소는 반드시 트랜잭션 내부에서 수행된다.

### DR-04. 재고 조회는 ProductStock에서 이루어진다.

### DR-05. ProductStock은 재고 감소/증가에 대한 유일한 데이터 소스이다.

---

## 6. 예시 도메인 시퀀스 (구매 요청 흐름)

```
[Client]
    ↓ purchase request
[LockStrategy]
    ↓ Pessimistic OR Optimistic OR RedisLock
[ProductStock]
    ↓ 재고 감소
[StockDecreaseLog]
    ↓ 결과 기록
Client ← 결과 반환
```

---

## 7. TODO

* ERD 생성
* DDL 작성
* 도메인 엔티티 클래스(Java) 설계
