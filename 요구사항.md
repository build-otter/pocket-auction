## 재고관리 시스템 – 요구사항 정의

### BR-01. 재고 정합성 보장

여러 사용자가 동시에 같은 상품을 구매해도
재고는 절대 음수로 떨어지면 안 된다.

재고 초과 구매는 발생해서는 안 된다.

동일 요청을 중복 처리하지 않아야 한다(idempotency).

---
### BR-02. 재고 감소 처리 성능

단일 상품에 대해 동시에 수백~수천 건의 요청이 올 수 있다.

재고 감소 API는 높은 TPS를 유지해야 한다.

다양한 동시성 제어 전략을 환경 설정으로 변경할 수 있어야 한다.

---
### BR-03. 재고 증감 이벤트 기록

성공/실패와 관계없이 모든 재고 감소 요청을 기록해야 한다.

사후 감사(Audit) 및 데이터 정합성 검증을 위해
요청 ID, 전략(Pessimistic/Optimistic/Redis), 응답시간, 결과 등을 남겨야 한다.

---
### BR-04. 재고 조회는 고성능이어야 함

재고는 상세 페이지, 리스트 페이지 등에서 자주 조회된다.

조회가 구매 요청에 의해 블로킹되면 안 된다.

캐시(예: Redis)로 조회 성능을 높이는 것도 고려해야 한다.

---
### BR-05. 재고 부족 처리

재고가 부족할 경우 구매 처리 실패 응답을 반환해야 한다.

실패 사유는 OUT_OF_STOCK 등 명확한 상태로 전달해야 한다.

---
### BR-06. 주문 중복 처리 방지

동일한 requestId(UUID)로 들어온 요청은 한 번만 처리해야 한다 (idempotency).

네트워크 재시도 상황에서도 재고 중복 감소가 되면 안 된다.

---
### BR-07. 장애 시 재처리 및 장애 복구 필요

DB 트랜잭션 실패 / Lock timeout / Redis 장애 등은 정상 처리되어야 한다.

일정 횟수 재시도 후 실패 처리.

---
### BR-08. 모니터링 및 통계 제공

전략별 성공/실패 카운트

평균/최대 응답시간

Lock 경합률

Deadlock 발생 수

재고 정합성 검증 리포트 

---

## 기능 요구사항

###   FR-01. 상품 생성

관리자 또는 테스트 용도로 상품과 초기 재고를 등록할 수 있어야 한다.
---
### FR-02. 재고 조회 API

- /products/{id}/stock 
- 실시간 재고 조회
- 캐시 사용 여부 선택 가능
---
### FR-03. 재고 감소 API

- /products/{id}/purchase

  - 요청 파라미터:
  1. quantity
  2. requestId (중복 처리 방지)
  3. strategy (optional: default=PESSIMISTIC)

- 처리 흐름:
  1. 요청 ID 중복 검사
  2. 선택된 전략에 따른 재고 감소 실행
  3. 결과 로그 저장
---
### FR-04. 동시성 전략 선택

- 재고 감소 처리 시 클라이언트 또는 서버 설정에서
다음 전략 중 하나를 선택할 수 있어야 함:

  1. Pessimistic Lock (DB Row-Level Lock)
  2. Optimistic Lock (Version 기반)
  3. Redis Distributed Lock 
  4. Lua Script 기반 atomic 감소
---
### FR-05. DB 정합성 검증 기능

일정 주기마다 재고 테이블과 로그 테이블을 비교해
실제 감소량이 올바른지 검증하는 배치 존재
---
### FR-06. Deadlock / Lock Timeout 처리

비관적 락 사용 시

Deadlock → 트랜잭션 롤백 후 재시도

Lock Timeout → 실패 또는 재시도 전략

---
### FR-07. 재고 조정 기능 (관리자)

잘못된 데이터 수정용

증감 시 이력 남겨야 함

### FR-08. 실패 로그 저장

예외/장애 발생 시 상세 이유를 로그 테이블에 저장해야 한다.

실패 사유: DEADLOCK, VERSION_CONFLICT, LOCK_TIMEOUT, REDIS_LOCK_FAIL, etc.